<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quotes Admin</title>
</head>

<body>
  <h1>Quotes Admin</h1>
  <h2>Add a Quote (POST)</h2>
  <!-- AI prompt - "I need an HTML form with content, author and id fields" -->
  <!-- Nice Reference: https://www.w3schools.com/html/html_forms.asp -->
  <div id="form-new-quote">
    <label for="txt-content">Quote:</label><br>
    <textarea id="txt-content" name="content" rows="4" required></textarea><br><br>
    <label for="txt-author">Author:</label><br>
    <input type="text" id="txt-author" name="author" required><br><br>
    <label for="txt-id">ID:</label><br>
    <input id="txt-id" name="id" required size="38" readonly><br><br>
    <button type='button' id="btn-submit">submit</button>
  </div>
  <hr>
  <h2>POST Results</h2>
  <div id="post-results">
    <p></p>
    <pre></pre>
  </div>
  <hr>
  <hr>
  <h2>Delete Quote</h2>
  <button id="btn-delete">Delete</button> | <input id="delete-id" size="38">
  <h3>DELETE Results</h3>
  <div id="delete-results">
    <p></p>
    <pre></pre>
  </div>
  <hr>
  <hr>
  <h2>View All Quotes</h2>
  <div id="all-quotes"></div>
  <script>

    const newQuoteForm = document.querySelector("#form-new-quote");
    const content = document.querySelector("#txt-content");
    const author = document.querySelector("#txt-author");
    const id = document.querySelector("#txt-id");
    const url = "http://localhost:3000/quotes";
    // 1. HELPERS
    const generateNewId = () => crypto.randomUUID();
    const postNewQuote = async (url, payload, callback) => {
      let json;
      let status;
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "accept": "application/json",
            "content-type": "application/json"
          },
          body: JSON.stringify(payload),
        });
        json = await response.json();
        status = `status: ${response.status} : ${response.statusText}`;
      } catch (error) {
        console.error("Error:", error);
        json = { author: `Can't parse data file '${url}'` }
      }
      finally {
        callback(json, status);
      }
    };
    const postCallback = (json, status) => {
      console.log("postCallback", json, status);
      document.querySelector("#post-results p").innerHTML = status;
      document.querySelector("#post-results pre").innerHTML = JSON.stringify(json);
    };



    document.querySelector('#btn-submit').addEventListener('click', evt => {
      //evt.preventDefault();
      // const url = newQuoteForm.action;
      // const content = newQuoteForm["content"].value;
      // const author = newQuoteForm["author"].value;
      // const id = newQuoteForm["id"].value;


      const payload = {
        content: content.value,
        author: author.value,
        id: id.value,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      //console.log("payload", payload);
      postNewQuote(url, payload, postCallback);
      content.value = "";
      author.value = "";
      id.value = "";
      postCallback(payload, "status: 200 : OK");
      
    });

    id.value = generateNewId();
    const allQuotes = document.querySelector("#all-quotes");
    const deleteResults = document.querySelector("#delete-results");
    const deleteId = document.querySelector("#delete-id");

    const deleteQuote = async (url, id, callback) => {
      let json;
      let status;
      try {
        const response = await fetch(`${url}/${id}`, {
          method: "DELETE",
          headers: {
            "accept": "application/json",
            "content-type": "application/json"
          },
        });
        json = await response.json();
        status = `status: ${response.status} : ${response.statusText}`;
      } catch (error) {
        console.error("Error:", error);
        json = { author: `Can't parse data file '${url}'` }
      }
      finally {
        callback(json, status);
      }
    };

    const updateQuotes = async () => {
      let json;
      try {
        const response = await fetch(url);
        json = await response.json();
      } catch (error) {
        console.error("Error:", error);
        json = { author: `Can't parse data file '${url}'` }
      }
      finally {
        allQuotes.innerHTML = json.map(quote => `<p>${quote.content} - ${quote.author}  (${quote.id})</p>`).join("");
      }
    };

    updateQuotes();
  </script>
</body>

</html>